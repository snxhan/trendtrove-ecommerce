import{g as F}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{a6 as b,R as D,a0 as K,aS as G,j as e,b as H,cR as W,b2 as X,r as I,a8 as J,a9 as U,v as P,cS as Y,t as O,w as t,ab as Z,B as Q,a7 as ee,V as se,bc as ie,m as te,aB as ne,T as R,x as le}from"./index-Cr7wFzsV.js";import{u as ae}from"./chunk-BF3VCHXD-DHYf2Zsu.js";import{K as re}from"./chunk-6HTZNHPT-Bx5jOcaR.js";import{R as w,u as oe}from"./chunk-JGQGO74V-BjbOW5Cw.js";import{S as p}from"./select-BCV7IXax.js";import{A as z}from"./alert-Cr0Fjs1Q.js";import"./prompt-CRI2UiR4.js";import"./triangles-mini-BxjM2N5x.js";import"./check-Cn7MNPQx.js";import"./x-mark-mini-C5VOj4mU.js";var ce=b.object({quantity:b.record(b.string(),b.number()),location_id:b.string(),shipping_option_id:b.string().optional(),send_notification:b.boolean().optional()});function de({item:i,form:f,locationId:n,itemReservedQuantitiesMap:v,disabled:_}){const{t:h}=H(),{variant:j}=ee(i.product_id,i.variant_id,{fields:"*inventory,*inventory.location_levels"},{enabled:!!i.variant}),{availableQuantity:N,inStockQuantity:S}=I.useMemo(()=>{var q,g;if(!j||!n)return{};const{inventory:x}=j,d=(g=(q=x[0])==null?void 0:q.location_levels)==null?void 0:g.find(M=>M.location_id===n);if(!d)return{};const o=v.get(i.id)??0;return{availableQuantity:d.available_quantity+o,inStockQuantity:d.stocked_quantity}},[j,n,v]),C=0,l=Math.min(F(i),N||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-row items-center",children:[_&&e.jsx("div",{className:"inline-flex items-center ml-4",children:e.jsx(se,{content:h("orders.fulfillment.disabledItemTooltip"),side:"top",children:e.jsx(ie,{className:"text-ui-tag-orange-icon"})})}),e.jsxs("div",{className:te("flex flex-col flex-1 gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",_&&"opacity-50 pointer-events-none"),children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(ne,{src:i.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(R,{className:"txt-small",as:"span",weight:"plus",children:i.title}),i.variant_sku&&e.jsxs("span",{children:["(",i.variant_sku,")"]})]}),e.jsx(R,{as:"div",className:"text-ui-fg-subtle txt-small",children:i.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:h("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:N||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:h("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[S||"N/A"," ",S&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",f.getValues(`quantity.${i.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(t.Field,{control:f.control,name:`quantity.${i.id}`,rules:{required:!0,min:C,max:l},render:({field:x})=>e.jsxs(t.Item,{children:[e.jsx(t.Control,{children:e.jsx(le,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...x,onChange:d=>{const o=d.target.value===""?null:Number(d.target.value);x.onChange(o),isNaN(o)||(o<C||o>l?f.setError(`quantity.${i.id}`,{type:"manual",message:h("orders.fulfillment.error.wrongQuantity",{count:l,number:l})}):f.clearErrors(`quantity.${i.id}`))}})}),e.jsx(t.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",i.quantity," ",h("fields.qty")]})]})]})]})]})})}function me({order:i,requiresShipping:f}){var V,k;const{t:n}=H(),{handleSuccess:v}=oe(),{mutateAsync:_,isPending:h}=W(i.id),{reservations:j}=X({line_item_id:i.items.map(s=>s.id)}),N=I.useMemo(()=>new Map((j||[]).map(s=>[s.line_item_id,s.quantity])),[j]),[S,C]=I.useState(()=>(i.items||[]).filter(s=>s.requires_shipping===f&&F(s)>0)),l=J({defaultValues:{quantity:S.reduce((s,r)=>(s[r.id]=F(r),s),{}),send_notification:!i.no_notification},resolver:U(ce)}),x=P({name:"location_id",control:l.control}),{stock_locations:d=[]}=Y(),{shipping_options:o=[],isLoading:q}=ae({stock_location_id:x,fields:"+service_zone.fulfillment_set.location.id"}),g=P({name:"shipping_option_id",control:l.control}),M=l.handleSubmit(async s=>{const r=o.find(u=>u.id===g);if(!r){l.setError("shipping_option_id",{type:"manual",message:n("orders.fulfillment.error.noShippingOption")});return}if(!x){l.setError("location_id",{type:"manual",message:n("orders.fulfillment.error.noLocation")});return}const c=r==null?void 0:r.shipping_profile_id,a=i.items.reduce((u,y)=>{var T,L,A;return u[y.id]=(A=(L=(T=y.variant)==null?void 0:T.product)==null?void 0:L.shipping_profile)==null?void 0:A.id,u},{}),m=Object.entries(s.quantity).filter(([u,y])=>!!y&&a[u]===c).map(([u,y])=>({id:u,quantity:y}));if(!m.length){O.error(n("orders.fulfillment.error.noItems"));return}const E={location_id:x,shipping_option_id:g,no_notification:!s.send_notification,items:m};try{await _(E),O.success(n("orders.fulfillment.toast.created")),v(`/orders/${i.id}`)}catch(u){O.error(u.message)}});I.useEffect(()=>{var s,r;if(d!=null&&d.length&&(o!=null&&o.length)){const c=(r=(s=i.shipping_methods)==null?void 0:s[0])==null?void 0:r.shipping_option_id;if(c){const a=o.find(m=>m.id===c);if(a){const m=a.service_zone.fulfillment_set.location.id;l.setValue("location_id",m),l.setValue("shipping_option_id",c||void 0)}}}},[d==null?void 0:d.length,o==null?void 0:o.length]);const $=(i.items||[]).map(s=>s.requires_shipping===f&&s.detail.fulfilled_quantity);I.useEffect(()=>{var c;const s=((c=i==null?void 0:i.items)==null?void 0:c.filter(a=>a.requires_shipping===f&&F(a)>0))||[];C(s),s.length?l.clearErrors("root"):l.setError("root",{type:"manual",message:n("orders.fulfillment.error.noItems")});const r=s.reduce((a,m)=>(a[m.id]=F(m),a),{});l.setValue("quantity",r)},[...$,f]);const B=g&&((k=(V=i.shipping_methods)==null?void 0:V[0])==null?void 0:k.shipping_option_id)!==g;return e.jsx(w.Form,{form:l,children:e.jsxs(re,{onSubmit:M,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(w.Header,{}),e.jsx(w.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(t.Field,{control:l.control,name:"location_id",render:({field:{onChange:s,ref:r,...c}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(t.Label,{children:n("fields.location")}),e.jsx(t.Hint,{children:n("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(t.Control,{children:e.jsxs(p,{onValueChange:s,...c,children:[e.jsx(p.Trigger,{className:"bg-ui-bg-base",ref:r,children:e.jsx(p.Value,{})}),e.jsx(p.Content,{children:d.map(a=>e.jsx(p.Item,{value:a.id,children:a.name},a.id))})]})})})]}),e.jsx(t.ErrorMessage,{})]})})}),e.jsxs("div",{className:"py-8",children:[e.jsx(t.Field,{control:l.control,name:"shipping_option_id",render:({field:{onChange:s,ref:r,...c}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(t.Label,{children:n("fields.shippingMethod")}),e.jsx(t.Hint,{children:n("orders.fulfillment.methodDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(t.Control,{children:e.jsxs(p,{onValueChange:s,...c,disabled:!x,children:[e.jsx(p.Trigger,{className:"bg-ui-bg-base",ref:r,children:q?e.jsxs("span",{className:"text-right",children:[n("labels.loading"),"..."]}):e.jsx(p.Value,{})}),e.jsx(p.Content,{children:o.map(a=>e.jsx(p.Item,{value:a.id,children:a.name},a.id))})]})})})]}),e.jsx(t.ErrorMessage,{})]})}),B&&e.jsxs(z,{className:"mt-4 p-4",variant:"warning",children:[e.jsx("span",{className:"-mt-[3px] block font-medium",children:n("labels.beaware")}),e.jsx("span",{className:"text-ui-fg-muted",children:n("orders.fulfillment.differentOptionSelected")})]})]}),e.jsxs("div",{children:[e.jsxs(t.Item,{className:"mt-8",children:[e.jsx(t.Label,{children:n("orders.fulfillment.itemsToFulfill")}),e.jsx(t.Hint,{children:n("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:S.map(s=>{var c,a,m,E;const r=((c=o.find(u=>u.id===g))==null?void 0:c.shipping_profile_id)===((E=(m=(a=s.variant)==null?void 0:a.product)==null?void 0:m.shipping_profile)==null?void 0:E.id);return e.jsx(de,{form:l,item:s,locationId:x,disabled:!r,itemReservedQuantitiesMap:N},s.id)})})]}),l.formState.errors.root&&e.jsx(z,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:l.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(t.Field,{control:l.control,name:"send_notification",render:({field:{onChange:s,value:r,...c}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(t.Label,{children:n("orders.returns.sendNotification")}),e.jsx(t.Control,{children:e.jsx(t.Control,{children:e.jsx(Z,{checked:!!r,onCheckedChange:s,...c})})})]}),e.jsx(t.Hint,{className:"!mt-1",children:n("orders.fulfillment.sendNotificationHint")}),e.jsx(t.ErrorMessage,{})]})})})]})})})}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(Q,{size:"small",variant:"secondary",children:n("actions.cancel")})}),e.jsx(Q,{size:"small",type:"submit",isLoading:h,disabled:!g,children:n("orders.fulfillment.create")})]})})]})})}function ye(){const{id:i}=D(),[f]=K(),n=f.get("requires_shipping")==="true",{order:v,isLoading:_,isError:h,error:j}=G(i,{fields:"currency_code,*items,*items.variant,+items.variant.product.shipping_profile.id,*shipping_address,+shipping_methods.shipping_option_id"});if(h)throw j;const N=!_&&v;return e.jsx(w,{children:N&&e.jsx(me,{order:v,requiresShipping:n})})}export{ye as Component};
